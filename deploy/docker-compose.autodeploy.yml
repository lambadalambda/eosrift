services:
  deployhook:
    build:
      context: .
      target: deployhook
    restart: unless-stopped
    environment:
      EOSRIFT_DEPLOY_WEBHOOK_LISTEN_ADDR: "${EOSRIFT_DEPLOY_WEBHOOK_LISTEN_ADDR:-:8091}"
      EOSRIFT_DEPLOY_WEBHOOK_SECRET: "${EOSRIFT_DEPLOY_WEBHOOK_SECRET:-}"
      EOSRIFT_DEPLOY_WEBHOOK_WORKFLOW: "${EOSRIFT_DEPLOY_WEBHOOK_WORKFLOW:-Docker Image}"
      EOSRIFT_DEPLOY_WEBHOOK_BRANCH: "${EOSRIFT_DEPLOY_WEBHOOK_BRANCH:-main}"
      EOSRIFT_DEPLOY_WEBHOOK_REPOSITORY: "${EOSRIFT_DEPLOY_WEBHOOK_REPOSITORY:-}"
      EOSRIFT_DEPLOY_TIMEOUT: "${EOSRIFT_DEPLOY_TIMEOUT:-10m}"
      EOSRIFT_DEPLOY_COMMAND: "${EOSRIFT_DEPLOY_COMMAND:-/workspace/deploy/webhook/eosrift-deploy.sh}"
      EOSRIFT_DEPLOY_COMMAND_ARGS: "${EOSRIFT_DEPLOY_COMMAND_ARGS:-}"
      EOSRIFT_DEPLOY_WORKDIR: "${EOSRIFT_DEPLOY_WORKDIR:-/workspace}"
      EOSRIFT_DEPLOY_COMPOSE_FILES: "${EOSRIFT_DEPLOY_COMPOSE_FILES:-docker-compose.yml:deploy/docker-compose.autodeploy.yml}"
      EOSRIFT_DEPLOY_SERVICE: "${EOSRIFT_DEPLOY_SERVICE:-server}"
      EOSRIFT_DEPLOY_HEALTH_URL: "${EOSRIFT_DEPLOY_HEALTH_URL:-http://server:8080/healthz}"
      EOSRIFT_DEPLOY_HEALTH_ATTEMPTS: "${EOSRIFT_DEPLOY_HEALTH_ATTEMPTS:-30}"
      EOSRIFT_DEPLOY_HEALTH_SLEEP_SECONDS: "${EOSRIFT_DEPLOY_HEALTH_SLEEP_SECONDS:-2}"
      EOSRIFT_DEPLOY_STATUS_PATH: "${EOSRIFT_DEPLOY_STATUS_PATH:-/data/deploy-status.json}"
    expose:
      - "8091"
    volumes:
      - .:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
      - eosrift-data:/data

  server:
    environment:
      EOSRIFT_DEPLOY_STATUS_PATH: "${EOSRIFT_DEPLOY_STATUS_PATH:-/data/deploy-status.json}"
