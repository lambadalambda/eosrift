name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version string to embed in binaries (e.g. v0.1.0-dryrun)"
        required: true
        default: "v0.0.0-dryrun"

permissions:
  contents: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event_name == 'workflow_dispatch' && inputs.version || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build release artifacts
        run: |
          set -euo pipefail

          DIST="dist"
          rm -rf "${DIST}"
          mkdir -p "${DIST}"

          build() {
            local name="$1"
            local pkg="$2"
            local goos="$3"
            local goarch="$4"

            local dir="${name}_${VERSION}_${goos}_${goarch}"
            mkdir -p "${DIST}/${dir}"

            CGO_ENABLED=0 GOOS="${goos}" GOARCH="${goarch}" \
              go build -trimpath \
                -ldflags "-s -w -X eosrift.com/eosrift/internal/cli.version=${VERSION}" \
                -o "${DIST}/${dir}/${name}" \
                "${pkg}"

            (cd "${DIST}" && tar -czf "${dir}.tar.gz" "${dir}")
            rm -rf "${DIST:?}/${dir}"
          }

          # Client (Linux + macOS).
          for GOARCH in amd64 arm64; do
            build "eosrift" "./cmd/client" "linux" "${GOARCH}"
            build "eosrift" "./cmd/client" "darwin" "${GOARCH}"
          done

          # Server (Linux only).
          for GOARCH in amd64 arm64; do
            build "eosrift-server" "./cmd/server" "linux" "${GOARCH}"
          done

          (cd "${DIST}" && sha256sum *.tar.gz > checksums.txt)

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign checksums (keyless)
        run: |
          set -euo pipefail
          cosign sign-blob --yes \
            --output-signature dist/checksums.txt.sig \
            --output-certificate dist/checksums.txt.pem \
            dist/checksums.txt

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.tar.gz
            dist/checksums.txt
            dist/checksums.txt.sig
            dist/checksums.txt.pem
          generate_release_notes: true

      - name: Upload workflow artifacts (dry-run)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ env.VERSION }}
          path: dist/
          if-no-files-found: error
